<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMM Swap 交互界面</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
        }
        input, button {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
            border: none;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .pool-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>AMM Swap 智能合约交互界面</h1>
    
    <div class="container">
        <div class="section">
            <h3>连接钱包</h3>
            <button id="connectWallet">连接 MetaMask</button>
            <div id="walletStatus" class="status info" style="display: none;">
                钱包已连接: <span id="walletAddress"></span>
            </div>
        </div>

        <div class="section">
            <h3>合约地址配置</h3>
            <input type="text" id="tokenAAddress" placeholder="Token A 地址" style="width: 300px;">
            <input type="text" id="tokenBAddress" placeholder="Token B 地址" style="width: 300px;">
            <input type="text" id="ammSwapAddress" placeholder="AMM Swap 合约地址" style="width: 300px;">
            <button id="loadContracts">加载合约</button>
        </div>

        <div class="grid">
            <div class="section">
                <h3>流动性池信息</h3>
                <div class="pool-info">
                    <p>Token A 储备量: <span id="reserve0">-</span></p>
                    <p>Token B 储备量: <span id="reserve1">-</span></p>
                    <p>LP 代币总供应量: <span id="totalSupply">-</span></p>
                    <p>您的 LP 代币余额: <span id="userLpBalance">-</span></p>
                </div>
                <button id="refreshPoolInfo">刷新池信息</button>
            </div>

            <div class="section">
                <h3>代币余额</h3>
                <div class="pool-info">
                    <p>Token A 余额: <span id="tokenABalance">-</span></p>
                    <p>Token B 余额: <span id="tokenBBalance">-</span></p>
                </div>
                <button id="refreshBalances">刷新余额</button>
            </div>
        </div>

        <div class="section">
            <h3>添加流动性</h3>
            <input type="number" id="amount0" placeholder="Token A 数量" step="0.01">
            <input type="number" id="amount1" placeholder="Token B 数量" step="0.01">
            <button id="addLiquidity">添加流动性</button>
            <div id="addLiquidityStatus"></div>
        </div>

        <div class="section">
            <h3>代币交换</h3>
            <select id="swapDirection">
                <option value="AtoB">Token A → Token B</option>
                <option value="BtoA">Token B → Token A</option>
            </select>
            <input type="number" id="swapAmount" placeholder="输入数量" step="0.01">
            <input type="number" id="minAmountOut" placeholder="最小输出量" step="0.01">
            <button id="swap">执行交换</button>
            <div id="swapStatus"></div>
        </div>

        <div class="section">
            <h3>移除流动性</h3>
            <input type="number" id="removeLiquidity" placeholder="LP 代币数量" step="0.01">
            <button id="removeLiquidityBtn">移除流动性</button>
            <div id="removeLiquidityStatus"></div>
        </div>
    </div>

    <script>
        let provider, signer, tokenA, tokenB, ammSwap;
        let userAddress;

        // ABI 定义（简化版）
        const ERC20_ABI = [
            "function balanceOf(address owner) view returns (uint256)",
            "function approve(address spender, uint256 amount) returns (bool)",
            "function transfer(address to, uint256 amount) returns (bool)",
            "function decimals() view returns (uint8)",
            "function symbol() view returns (string)"
        ];

        const AMM_SWAP_ABI = [
            "function token0() view returns (address)",
            "function token1() view returns (address)",
            "function getReserves() view returns (uint256, uint256)",
            "function totalSupply() view returns (uint256)",
            "function balanceOf(address owner) view returns (uint256)",
            "function addLiquidity(uint256 amount0Desired, uint256 amount1Desired, uint256 minLiquidity) returns (uint256)",
            "function swap(address tokenIn, uint256 amountIn, uint256 minAmountOut)",
            "function removeLiquidity(uint256 liquidity, uint256 minAmount0, uint256 minAmount1)"
        ];

        // 连接钱包
        document.getElementById('connectWallet').addEventListener('click', async () => {
            try {
                if (typeof window.ethereum !== 'undefined') {
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    userAddress = await signer.getAddress();
                    
                    document.getElementById('walletStatus').style.display = 'block';
                    document.getElementById('walletAddress').textContent = userAddress;
                    
                    showStatus('钱包连接成功！', 'success');
                } else {
                    showStatus('请安装 MetaMask！', 'error');
                }
            } catch (error) {
                showStatus('连接钱包失败: ' + error.message, 'error');
            }
        });

        // 加载合约
        document.getElementById('loadContracts').addEventListener('click', async () => {
            try {
                const tokenAAddress = document.getElementById('tokenAAddress').value;
                const tokenBAddress = document.getElementById('tokenBAddress').value;
                const ammSwapAddress = document.getElementById('ammSwapAddress').value;

                if (!tokenAAddress || !tokenBAddress || !ammSwapAddress) {
                    showStatus('请填写所有合约地址！', 'error');
                    return;
                }

                tokenA = new ethers.Contract(tokenAAddress, ERC20_ABI, signer);
                tokenB = new ethers.Contract(tokenBAddress, ERC20_ABI, signer);
                ammSwap = new ethers.Contract(ammSwapAddress, AMM_SWAP_ABI, signer);

                showStatus('合约加载成功！', 'success');
                await refreshAll();
            } catch (error) {
                showStatus('加载合约失败: ' + error.message, 'error');
            }
        });

        // 刷新所有信息
        async function refreshAll() {
            await refreshPoolInfo();
            await refreshBalances();
        }

        // 刷新池信息
        document.getElementById('refreshPoolInfo').addEventListener('click', refreshPoolInfo);
        async function refreshPoolInfo() {
            try {
                const [reserve0, reserve1] = await ammSwap.getReserves();
                const totalSupply = await ammSwap.totalSupply();
                const userLpBalance = await ammSwap.balanceOf(userAddress);

                document.getElementById('reserve0').textContent = ethers.utils.formatEther(reserve0);
                document.getElementById('reserve1').textContent = ethers.utils.formatEther(reserve1);
                document.getElementById('totalSupply').textContent = ethers.utils.formatEther(totalSupply);
                document.getElementById('userLpBalance').textContent = ethers.utils.formatEther(userLpBalance);
            } catch (error) {
                showStatus('刷新池信息失败: ' + error.message, 'error');
            }
        }

        // 刷新余额
        document.getElementById('refreshBalances').addEventListener('click', refreshBalances);
        async function refreshBalances() {
            try {
                const tokenABalance = await tokenA.balanceOf(userAddress);
                const tokenBBalance = await tokenB.balanceOf(userAddress);

                document.getElementById('tokenABalance').textContent = ethers.utils.formatEther(tokenABalance);
                document.getElementById('tokenBBalance').textContent = ethers.utils.formatEther(tokenBBalance);
            } catch (error) {
                showStatus('刷新余额失败: ' + error.message, 'error');
            }
        }

        // 添加流动性
        document.getElementById('addLiquidity').addEventListener('click', async () => {
            try {
                const amount0 = ethers.utils.parseEther(document.getElementById('amount0').value);
                const amount1 = ethers.utils.parseEther(document.getElementById('amount1').value);

                // 批准代币
                await tokenA.approve(ammSwap.address, amount0);
                await tokenB.approve(ammSwap.address, amount1);

                // 添加流动性
                const tx = await ammSwap.addLiquidity(amount0, amount1, 0);
                await tx.wait();

                showStatus('添加流动性成功！', 'success');
                await refreshAll();
            } catch (error) {
                showStatus('添加流动性失败: ' + error.message, 'error');
            }
        });

        // 执行交换
        document.getElementById('swap').addEventListener('click', async () => {
            try {
                const direction = document.getElementById('swapDirection').value;
                const amount = ethers.utils.parseEther(document.getElementById('swapAmount').value);
                const minAmountOut = ethers.utils.parseEther(document.getElementById('minAmountOut').value);

                const tokenIn = direction === 'AtoB' ? tokenA.address : tokenB.address;
                
                // 批准代币
                await (direction === 'AtoB' ? tokenA : tokenB).approve(ammSwap.address, amount);

                // 执行交换
                const tx = await ammSwap.swap(tokenIn, amount, minAmountOut);
                await tx.wait();

                showStatus('交换成功！', 'success');
                await refreshAll();
            } catch (error) {
                showStatus('交换失败: ' + error.message, 'error');
            }
        });

        // 移除流动性
        document.getElementById('removeLiquidityBtn').addEventListener('click', async () => {
            try {
                const liquidity = ethers.utils.parseEther(document.getElementById('removeLiquidity').value);

                const tx = await ammSwap.removeLiquidity(liquidity, 0, 0);
                await tx.wait();

                showStatus('移除流动性成功！', 'success');
                await refreshAll();
            } catch (error) {
                showStatus('移除流动性失败: ' + error.message, 'error');
            }
        });

        // 显示状态信息
        function showStatus(message, type) {
            const statusDiv = document.createElement('div');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            
            // 移除之前的状态信息
            const existingStatus = document.querySelector('.status');
            if (existingStatus) {
                existingStatus.remove();
            }
            
            document.body.appendChild(statusDiv);
            
            // 3秒后自动移除
            setTimeout(() => {
                statusDiv.remove();
            }, 3000);
        }

        // 监听 MetaMask 账户变化
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', function (accounts) {
                window.location.reload();
            });
        }
    </script>
</body>
</html> 